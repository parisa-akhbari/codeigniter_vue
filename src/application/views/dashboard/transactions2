<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت تراکنش‌ها</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .persian-picker-wrapper { position: relative; }
        .persian-picker-panel {
            position: absolute;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            top: 45px;
            width: 260px;
            z-index: 999999;
        }
        .grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day { padding: 5px; cursor: pointer; }
        .day:hover { background: #eee; border-radius: 5px; }
        .empty { visibility: hidden; }
    </style>
</head>
<body class="bg-light">
<div class="container py-4" id="app">
    <h2 class="mb-4 text-primary">مدیریت تراکنش‌ها</h2>
    <button class="btn btn-success mb-4" @click="openCreateModal">افزودن تراکنش جدید</button>

    <!-- فرم جستجو -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <input type="text" v-model="filters.title" class="form-control" placeholder="جستجوی عنوان...">
                </div>
                <div class="col-md-2">
                    <select v-model="filters.type" class="form-select">
                        <option value="">همه نوع‌ها</option>
                        <option value="income">درآمد</option>
                        <option value="expense">هزینه</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <persian-date-picker v-model="filters.start_date_shamsi" placeholder="از تاریخ"></persian-date-picker>
                </div>
                <div class="col-md-2">
                    <persian-date-picker v-model="filters.end_date_shamsi" placeholder="تا تاریخ"></persian-date-picker>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary me-2" @click="getData(1)">جستجو</button>
                    <button class="btn btn-secondary" @click="clearFilters">پاک کردن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول -->
    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>عنوان</th>
                    <th>مبلغ</th>
                    <th>نوع</th>
                    <th>دسته‌بندی</th>
                    <th>تاریخ</th>
                    <th class="text-center">عملیات</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="t in transactions" :key="t.id">
                    <td>{{ t.title }}</td>
                    <td class="text-start font-monospace">{{ Number(t.amount).toLocaleString('fa-IR') }}</td>
                    <td>
                        <span class="badge fs-6" :class="t.type==='income'?'bg-success':'bg-danger'">
                            {{ t.type==='income'?'درآمد':'هزینه' }}
                        </span>
                    </td>
                    <td>{{ t.category_title || '-' }}</td>
                    <td>{{ t.transaction_date_shamsi }}</td>
                    <td class="text-center">
                        <button @click="openEditModal(t)" class="btn btn-warning btn-sm">ویرایش</button>
                        <button @click="remove(t.id)" class="btn btn-danger btn-sm ms-1">حذف</button>
                    </td>
                </tr>
                <tr v-if="!transactions.length">
                    <td colspan="6" class="text-center py-5 text-muted">تراکنشی یافت نشد</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- صفحه‌بندی -->
    <nav v-if="pagesCount > 1" class="mt-5">
        <ul class="pagination justify-content-center">
            <li class="page-item" :class="{disabled: page===1}"><a class="page-link" @click="goPage(1)">اول</a></li>
            <li class="page-item" :class="{disabled: page===1}"><a class="page-link" @click="goPage(page-1)">قبلی</a></li>
            <template v-for="p in paginationPages" :key="p">
                <li class="page-item" :class="{active: p===page, disabled: p==='...'}">
                    <a v-if="p!=='...'" class="page-link" @click="goPage(p)">{{ p }}</a>
                    <span v-else class="page-link">{{ p }}</span>
                </li>
            </template>
            <li class="page-item" :class="{disabled: page===pagesCount}"><a class="page-link" @click="goPage(page+1)">بعدی</a></li>
            <li class="page-item" :class="{disabled: page===pagesCount}"><a class="page-link" @click="goPage(pagesCount)">آخر</a></li>
        </ul>
    </nav>

    <!-- مودال افزودن / ویرایش -->
    <div v-if="showModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ isEdit?'ویرایش تراکنش':'افزودن تراکنش جدید' }}</h5>
                    <button type="button" class="btn-close" @click="closeModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label>عنوان</label>
                            <input type="text" v-model="form.title" class="form-control" placeholder="عنوان">
                        </div>
                        <div class="col-md-6">
                            <label>مبلغ (تومان)</label>
                            <input type="number" v-model.number="form.amount" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label>نوع تراکنش</label>
                            <select v-model="form.type" class="form-select">
                                <option value="income">درآمد</option>
                                <option value="expense">هزینه</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>دسته‌بندی</label>
                            <select v-model="form.category_id" class="form-select">
                                <option value="">انتخاب کنید</option>
                                <option v-for="cat in categories" :value="cat.id">{{ cat.title }}</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label>تاریخ تراکنش (شمسی)</label>
                            <persian-date-picker v-model="form.transaction_date_shamsi" placeholder="تاریخ تراکنش (شمسی)"></persian-date-picker>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" @click="isEdit ? update() : create()">
                        {{ isEdit?'ذخیره تغییرات':'افزودن تراکنش' }}
                    </button>
                    <button class="btn btn-secondary" @click="closeModal">بستن</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const PersianDatePicker = {
    template: `
    <div class="persian-picker-wrapper">
        <input type="text" 
               class="form-control"
               :placeholder="placeholder"
               :readonly="true"
               :value="modelValue"
               @click="open=!open">
        <div v-if="open" class="persian-picker-panel shadow">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <button class="btn btn-sm btn-light" @click="prevMonth">&lt;</button>
                <strong>{{ jYear }}/{{ jMonth }}</strong>
                <button class="btn btn-sm btn-light" @click="nextMonth">&gt;</button>
            </div>
            <div class="grid text-center fw-bold">
                <div v-for="d in ['ش','ی','د','س','چ','پ','ج']">{{ d }}</div>
            </div>
            <div class="grid text-center mt-1">
                <div v-for="n in firstDay" class="empty"></div>
                <div v-for="day in daysInMonth" class="day" @click="select(day)">{{ day }}</div>
            </div>
        </div>
    </div>
    `,
    props:["modelValue","placeholder"],
    emits:["update:modelValue"],
    data(){ 
        const now=new Date();
        return {open:false,jYear:this.toJalali(now).jy,jMonth:this.toJalali(now).jm};
    },
    computed:{
        daysInMonth(){ return this.jMonth<=6?31:(this.jMonth<=11?30:29); },
        firstDay(){
            const {gy,gm,gd}=this.toGregorian(this.jYear,this.jMonth,1);
            return new Date(gy,gm-1,gd).getDay();
        }
    },
    methods:{
        select(day){
            const formatted=`${this.jYear}/${String(this.jMonth).padStart(2,'0')}/${String(day).padStart(2,'0')}`;
            this.$emit("update:modelValue",formatted);
            this.open=false;
        },
        nextMonth(){ if(this.jMonth===12){this.jMonth=1;this.jYear++;}else this.jMonth++; },
        prevMonth(){ if(this.jMonth===1){this.jMonth=12;this.jYear--;}else this.jMonth--; },
        toJalali(g){
            let gy=g instanceof Date?g.getFullYear():g.gy,gm=g instanceof Date?g.getMonth()+1:g.gm,gd=g instanceof Date?g.getDate():g.gd;
            const g_d_m=[0,31,(gy%4===0?29:28),31,30,31,30,31,31,30,31,30,31];
            let gy2=gm>2?gy+1:gy;
            let days=355666+365*gy+Math.floor((gy2+3)/4)-Math.floor((gy2+99)/100)+Math.floor((gy2+399)/400);
            for(let i=1;i<gm;++i)days+=g_d_m[i];
            days+=gd;
            let jy=-1595+33*Math.floor(days/12053);
            days%=12053;
            jy+=4*Math.floor(days/1461);
            days%=1461;
            if(days>365){jy+=Math.floor((days-1)/365);days=(days-1)%365;}
            let jm=days<186?1+Math.floor(days/31):7+Math.floor((days-186)/30);
            let jd=days<186?1+days%31:1+(days-186)%30;
            return {jy,jm,jd};
        },
        toGregorian(jy,jm,jd){
            jy+=1595;
            let days=-355668+365*jy+Math.floor(jy/33)*8+Math.floor(((jy%33)+3)/4);
            days+=jm<7?(jm-1)*31:(jm-7)*30+186;
            days+=jd;
            let gy=400*Math.floor(days/146097);
            days%=146097;
            if(days>36524){gy+=100*Math.floor(--days/36524);days%=36524;if(days>=365)days++;}
            gy+=4*Math.floor(days/1461);
            days%=1461;
            if(days>365){gy+=Math.floor((days-1)/365);days=(days-1)%365;}
            const g_d_m=[0,31,(gy%4===0?29:28),31,30,31,30,31,31,30,31,30,31];
            let gm=1;
            for(;gm<=12&&days>=g_d_m[gm];gm++)days-=g_d_m[gm];
            let gd=days+1;
            return {gy,gm,gd};
        }
    }
};

const {createApp}=Vue;
createApp({
    components:{'persian-date-picker':PersianDatePicker},
    data(){
        return {
            transactions:[],
            categories:[],
            page:1,total_rows:0,page_size:10,
            filters:{title:"",type:"",start_date_shamsi:"",end_date_shamsi:""},
            showModal:false,isEdit:false,
            form:{id:null,title:"",amount:"",type:"expense",category_id:"",transaction_date_shamsi:""}
        };
    },
    computed:{
        pagesCount(){ return Math.ceil(this.total_rows/this.page_size); },
        paginationPages(){
            const delta=2,range=[],rangeWithDots=[];
            for(let i=Math.max(2,this.page-delta);i<=Math.min(this.pagesCount-1,this.page+delta);i++)range.push(i);
            if(this.page-delta>2) rangeWithDots.push(1,'...');
            else for(let i=2;i<this.page-delta+1;i++)rangeWithDots.push(i);
            rangeWithDots.push(...range);
            if(this.page+delta<this.pagesCount-1) rangeWithDots.push('...',this.pagesCount);
            else for(let i=this.page+delta+1;i<this.pagesCount;i++) rangeWithDots.push(i);
            return [1,...rangeWithDots,this.pagesCount].filter((v,i,a)=>a.indexOf(v)===i);
        }
    },
    mounted(){ this.loadCategories(); this.getData(1); },
    methods:{
        async loadCategories(){ const res=await fetch("<?= site_url('transactions/api_list_categories') ?>"); const data=await res.json(); this.categories=data.categories||[]; },
        async getData(page=1){ this.page=page; const params=new URLSearchParams({page:this.page,title:this.filters.title,type:this.filters.type,start_date:this.filters.start_date_shamsi,end_date:this.filters.end_date_shamsi}); const res=await fetch("<?= site_url('transactions/api_search') ?>?"+params); const json=await res.json(); this.transactions=json.transactions; this.total_rows=json.total_rows; this.page=json.page; },
        goPage(p){ if(p==='...' || p===this.page)return; this.getData(p); },
        clearFilters(){ this.filters={title:"",type:"",start_date_shamsi:"",end_date_shamsi:""}; this.getData(1); },
        openCreateModal(){ this.isEdit=false; this.form={id:null,title:"",amount:"",type:"expense",category_id:"",transaction_date_shamsi:new Date().toLocaleDateString('fa-IR').replace(/[/]/g,'/')} ;this.showModal=true; },
        openEditModal(t){ this.isEdit=true; this.form={id:t.id,title:t.title,amount:t.amount,type:t.type,category_id:t.category_id,transaction_date_shamsi:t.transaction_date_shamsi}; this.showModal=true; },
        closeModal(){ this.showModal=false; },
        async create(){ if(!this.validateForm())return; const formData=new FormData(); Object.keys(this.form).forEach(k=>{if(k!=='id')formData.append(k,this.form[k]||'');}); await fetch("<?= site_url('transactions/api_create') ?>",{method:"POST",body:formData}); this.closeModal(); this.getData(this.page); },
        async update(){ if(!this.validateForm())return; const formData=new FormData(); Object.keys(this.form).forEach(k=>formData.append(k,this.form[k]||'')); await fetch("<?= site_url('transactions/api_update/') ?>"+this.form.id,{method:"POST",body:formData}); this.closeModal(); this.getData(this.page); },
        async remove(id){ if(!confirm("آیا از حذف این تراکنش مطمئن هستید؟"))return; await fetch("<?= site_url('transactions/api_delete/') ?>"+id,{method:"DELETE"}); this.getData(this.page); },
        validateForm(){ if(!this.form.title.trim())return alert("عنوان را وارد کنید"),false; if(!this.form.amount||this.form.amount<=0)return alert("مبلغ معتبر نیست"),false; if(!this.form.category_id)return alert("دسته‌بندی را انتخاب کنید"),false; if(!this.form.transaction_date_shamsi)return alert("تاریخ را انتخاب کنید"),false; return true; }
    }
}).mount("#app");
</script>
</body>
</html>
